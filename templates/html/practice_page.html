<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midover</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&family=Fraunces:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/practice_page.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="overlay" id="overlay">
    </div>
        <header>
            <button class="menu-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            <br>
            <h1 class="logo">Midover</h1>
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-sun" id="themeIcon"></i>
            </button>
        </header>
    
        <nav class="sidebar" id="sidebar">
            <ul>
                <li><a href="/personal_lk">Личный кабинет</a></li>
                <li><a href="/about_us">О нас</a></li>
            </ul>
        </nav>
    
        <div class="container">
            <section id="network" class="network-section">
                <div class="network-card">
                    <div class="network-value">Cетевой трафик</div>
                    <div class="network-label">
                        Сетевой трафик — это поток данных, передаваемых между устройствами в компьютерной сети. Он представляет собой совокупность всех пакетов информации, которые перемещаются через сеть для обеспечения связи между различными узлами (например, компьютерами, серверами, роутерами и другими устройствами). Качество и характеристики сетевого трафика могут значительно влиять на производительность сети и её способность удовлетворять потребности пользователей.
                    </div>
                </div>
            </section>
    
            <section id="image-section" class="image-section">
                <div class="slideshow-container">
                    <div class="mySlides fade">
                        <div class="image-card">
                            <img src="/static/img/anomalies.png" alt="Image 1">
                            <div class="image-caption">
                                <a href="https://timeweb.com/ru/community/articles/samye-gromkie-ddos-ataki-v-istorii" target="_blank">Самые крупные DDoS атаки</a>
                            </div>
                        </div>
                    </div>
                    <div class="mySlides fade">
                        <div class="image-card">
                            <img src="/static/img/main_page.png" alt="Image 2">
                            <div class="image-caption">
                                <a href="https://stormwall.pro/resources/terms/general/traffic" target="_blank">Подробнее о сетевом трафике</a>
                            </div>
                        </div>
                    </div>
                    <div class="mySlides fade">
                        <div class="image-card">
                            <img src="/static/img/svm_applicability.png" alt="Image 3">
                            <div class="image-caption">
                                <a href="https://www.securitylab.ru/analytics/535530.php" target="_blank">Подробнее об аномалиях сетевого трафика</a>
                            </div>
                        </div>
                    </div>
            
                    <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                    <a class="next" onclick="plusSlides(1)">&#10095;</a>
                </div>
            </section>
    
            <section id="anomalies" class="anomalies-section">
                <div class="anomalies-card">
                    <div class="anomalies-value">Аномалии</div>
                    <div class="anomalies-label">
                        Аномалии сетевого трафика — это необычные или подозрительные паттерны передачи данных в компьютерной сети, которые отклоняются от нормального или ожидаемого поведения. Такие аномалии могут указывать на различные проблемы, такие как кибератаки, сбои оборудования, ошибки конфигурации или другие неполадки.
                    </div>
                    <br>
                    <br>
                    <br>
                    <div class="anomalies-value">DDoS-атаки</div>
                    <div class="anomalies-label">
                        DDoS-атака (Distributed Denial of Service, распределенная атака типа "отказ в обслуживании") — это кибератака, направленная на то, чтобы сделать онлайн-сервис или веб-ресурс недоступным для пользователей. Это достигается путем перегрузки целевого сервера, сети или приложения огромным количеством запросов, которые исходят от множества источников одновременно.
                    </div>
                </div>
            </section>

            <section id="anomalies" class="anomalies-section">
                <div class="anomalies-card">
                    <div class="anomalies-value">Метрики нашей модели</div>
                    <br>
                    <br>
                    <div class="anomalies-label">
                        Вы можете не сомневаться в качестве нашего сервиса, потому что модель выдаёт потрясающие параметры
                    </div>
                    <br>
                    <div class="anomalies-label">
                        Убедитесь в этом ниже
                    </div>
                    <br>
                    <div class="anomalies-label">
                        <a href="#">Перед использованием прочитайте инструкцию по пользованию сервисом</a>
                    </div>
                </div>
            </section>

            <section id="metrics" class="metric-section">
                <div class="metric-card">
                    <div class="metric-value">98.5%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.97</div>
                    <div class="metric-label">F1-Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">0.99</div>
                    <div class="metric-label">AUC-ROC</div>
                </div>
            </section>
    
            <!-- Секция анализа -->
            <section id="analysis">
                <div class="dropzone-section" id="uploadSection">
                    <div class="dropzone" id="dropzone">
                        <i class="fas fa-cloud-upload-alt fa-3x"></i>
                        <p>Перетащите TXT/JSON файлы<br>или</p>
                        <input type="file" multiple id="fileInput">
                        <button class="analyze-btn" onclick="analyzeFiles()">Анализировать</button>
                    </div>

                    <div class="dropzone" id="dropzone">
                        <i class="fas fa-cloud-upload-alt fa-signal"></i>
                        <p>Анализировать трафик в реальном времени</p>
                        <button class="analyze-btn" onclick="javascript:location.href='http://localhost:8181';">Анализировать</button>
                    </div>
                </div>
    
                <!-- Результаты анализа -->
                <div class="analysis-results" id="resultsSection">
                    <div class="result-card">
                        
                        <div class="status-section">
                            <span class="anomaly-badge-label" id="statusBadgeLabel">Статус</span>
                            <span class="anomaly-badge" id="statusBadge"></span>
                        </div>
                        <br>
                        <br>
                        <button class="analyze-btn" onclick="exportResults()">Экспорт CSV</button>
                        <br>
                        <br>
                        <h2>Результаты анализа</h2>
                        <table class="result-table">
                            <thead>
                                <tr>
                                    <th>Параметр</th>
                                    <th>Значение</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody">
                                <!-- Сюда будут добавляться строки динамически -->
                            </tbody>
                        </table>
                        <!-- График -->
                        <!-- Комплексный график -->
                        <div class="chart-container">
                            <canvas id="combinedChart" width="800" height="400"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    
        <footer>
            <p>© 2025 Midover</p>
            <script src="/static/js/scroll_footer.js"></script>
        </footer>
    
        <script>
                let slideIndex = 0;
    
                // Инициализация слайд-шоу при загрузке страницы
                document.addEventListener("DOMContentLoaded", function () {
                    showSlides(slideIndex);
                });
                
                function showSlides(n) {
                    let slides = document.getElementsByClassName("mySlides");
                
                    // Скрываем все слайды
                    for (let i = 0; i < slides.length; i++) {
                        slides[i].style.display = "none";
                    }
                
                    // Обновляем индекс текущего слайда
                    slideIndex = (n + slides.length) % slides.length;
                
                    // Показываем текущий слайд
                    slides[slideIndex].style.display = "block";
                }
                
                function plusSlides(n) {
                    showSlides(slideIndex += n);
                }
                
                // Автоматическая смена слайдов каждые 5 секунд
                setInterval(function () {
                    plusSlides(1);
                }, 3000);
                
                        let theme = localStorage.getItem('theme') || 'dark';
                
                        function toggleTheme() {
                            const body = document.body;
                            const icon = document.getElementById('themeIcon');
                            
                            theme = theme === 'dark' ? 'light' : 'dark';
                            body.classList.toggle('light-theme', theme === 'light');
                            
                            icon.className = `fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'}`;
                            
                            localStorage.setItem('theme', theme);
                        }
                
                        function toggleMenu() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');

                // Переключаем класс 'active' для Sidebar
                sidebar.classList.toggle('active');

                // Показываем или скрываем виньетку
                if (sidebar.classList.contains('active')) {
                    overlay.style.display = 'block'; // Показываем виньетку
                } else {
                    overlay.style.display = 'none'; // Скрываем виньетку
                }
            }

            // Закрытие меню при клике на виньетку
            document.getElementById('overlay').addEventListener('click', function () {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');

                sidebar.classList.remove('active'); // Убираем класс 'active'
                overlay.style.display = 'none'; // Скрываем виньетку
            });
    
            function analyzeFiles() {
            const fileInput = document.getElementById('fileInput');
            const resultsSection = document.getElementById('resultsSection');
            const uploadSection = document.getElementById('uploadSection');
            const resultTableBody = document.getElementById('resultTableBody');
            
            // Очищаем таблицу перед новым анализом
            resultTableBody.innerHTML = '';
            
            // Проверяем, что файл выбран
            if (fileInput.files.length === 0) {
                alert("Пожалуйста, выберите файл.");
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function (event) {
                try {
                    // Читаем содержимое файла как строку
                    const fileContent = event.target.result;
                    // Преобразуем данные в массив и затем в JSON
                    const dataArray = fileContent.split(',').map(item => item.trim());
                    
                    // Создаём объект с ключами feature1, feature2, ..., feature41
                    const jsonData = {};
                    for (let i = 0; i < 41; i++) {
                        jsonData[`feature${i + 1}`] = dataArray[i] || '';
                    }
                    
                    // Отправляем JSON на сервер
                    fetch('http://127.0.0.1:5000/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const prediction = data.prediction;
                        
                        // Обновляем статус
                        const statusBadge = document.getElementById('statusBadge');
                        statusBadge.className = `anomaly-badge ${prediction === 0 ? 'status-normal' : 'status-anomaly'}`;
                        statusBadge.textContent = `${prediction === 0 ? 'Normal' : 'Anomaly'}`;
                        
                        // Сопоставление featureN и названий параметров
                        const featureNames = {
                            feature1: "Длительность соединения",
                            feature2: "Тип протокола",
                            feature3: "Сервис",
                            feature4: "Флаг TCP",
                            feature5: "Байт от источника",
                            feature6: "Байт к получателю",
                            feature7: "Ср. размер пакета",
                            feature8: "Ошибка SYN",
                            feature9: "Ошибка REJ",
                            feature10: "Тип сервиса",
                            feature11: "Ошибка DIFF_SRV",
                            feature12: "Ошибка DIFF_SRV_RATE",
                            feature13: "Ошибки",
                            feature14: "Ошибка SAME_SRV",
                            feature15: "Ошибка DIFF_SRV",
                            feature16: "Ошибка DST_HOST_SAME_SRV",
                            feature17: "Ошибка DST_HOST_DIFF_SRV",
                            feature18: "Ошибка DST_HOST_SAME_SRC_PORT",
                            feature19: "Ошибка DST_HOST_SAME_DST_PORT",
                            feature20: "Ошибка DST_HOST_SERROR_RATE",
                            feature21: "Ошибка DST_HOST_RERROR_RATE",
                            feature22: "Ошибка DST_HOST_SAME_SRV_RATE",
                            feature23: "Число соединений",
                            feature24: "Число ошибок",
                            feature25: "Частота ошибок SYN",
                            feature26: "Частота ошибок REJ",
                            feature27: "Частота ошибок DIFF_SRV",
                            feature28: "Частота ошибок SRC_TO_DST",
                            feature29: "Частота ошибок DST_TO_SRC",
                            feature30: "Сервисы одинаковые",
                            feature31: "Сервисы разные",
                            feature32: "Число соединений к хосту",
                            feature33: "Число ошибок к хосту",
                            feature34: "Сервисы на хосте одинаковые",
                            feature35: "Сервисы на хосте разные",
                            feature36: "Частота ошибок к хосту",
                            feature37: "Частота ошибок SYN к хосту",
                            feature38: "Частота ошибок REJ к хосту",
                            feature39: "Частота ошибок DIFF_SRV к хосту",
                            feature40: "Частота ошибок SRC_TO_DST к хосту",
                            feature41: "Частота ошибок DST_TO_SRC к хосту"
                        };
                        
                        // Ключевые параметры для выделения
                        const keyFeatures = [
                            "feature1", "feature2", "feature3", "feature4", "feature5", "feature6",
                            "feature23", "feature25", "feature27", "feature29", "feature30",
                            "feature32", "feature34"
                        ];
                        
                        // Добавляем все 41 параметра в таблицу
                        for (let i = 1; i <= 41; i++) {
                            const featureKey = `feature${i}`;
                            const paramName = featureNames[featureKey] || featureKey;
                            const value = jsonData[featureKey] !== '' ? parseFloat(jsonData[featureKey]).toFixed(2) : 'N/A';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${paramName}</td>
                                <td>${value}</td>
                            `;
                            
                            // Выделяем ключевые параметры
                            if (keyFeatures.includes(featureKey)) {
                                row.classList.add('highlight');
                            }
                            
                            resultTableBody.appendChild(row);
                        }
                        
                        // Строим графики
                        drawBarChart(jsonData);
                        
                        // Показываем результаты
                        uploadSection.style.display = 'none';
                        resultsSection.style.display = 'block';
                        // Прокрутка до секции с результатами
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' // 'start' - начало секции вверху, 'center' - по центру
                        });
                        //window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        alert(`Ошибка: ${error.message}`);
                    });
                } catch (error) {
                    console.error('Ошибка при обработке файла:', error);
                    alert(`Ошибка при обработке файла: ${error.message}`);
                }
            };
            
            // Начинаем чтение файла
            reader.readAsText(file);
        }
    
        function drawBarChart(data) {
    // Удаление старых графиков
    if (window.combinedChart instanceof Chart) {
        window.combinedChart.destroy();
    }

    // === Парсим данные ===
    const srcBytes = parseFloat(data.feature5) || 0;
    const dstBytes = parseFloat(data.feature6) || 0;
    const duration = parseFloat(data.feature1) || 0;
    const count = parseFloat(data.feature23) || 0;
    const serror = parseFloat(data.feature25) || 0;
    const rerror = parseFloat(data.feature27) || 0;
    const protocolType = parseFloat(data.feature2) || 0;
    const serviceType = parseFloat(data.feature3) || 0;
    const hostConnections = parseFloat(data.feature32) || 0;
    const sameHostService = parseFloat(data.feature34) || 0;
    const dstToSrcRate = parseFloat(data.feature29) || 0;

    // === Конфигурация графика ===
    const ctx = document.getElementById('combinedChart').getContext('2d');
    window.combinedChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Трафик', 'Соединения', 'Ошибки', 'Протоколы/Сервисы'],
            datasets: [
                // === Трафик ===
                {
                    label: 'От источника (байт)',
                    data: [srcBytes, null, null, null],
                    backgroundColor: '#FF6384',
                    yAxisID: 'y',
                    stack: 'stack1'
                },
                {
                    label: 'К получателю (байт)',
                    data: [dstBytes, null, null, null],
                    backgroundColor: '#36A2EB',
                    yAxisID: 'y',
                    stack: 'stack1'
                },

                // === Соединения ===
                {
                    label: 'Длительность (сек)',
                    data: [null, duration, null, null],
                    backgroundColor: '#FFCE56',
                    yAxisID: 'y',
                    stack: 'stack2'
                },
                {
                    label: 'Число соединений',
                    data: [null, count, null, null],
                    backgroundColor: '#4BC0C0',
                    yAxisID: 'y',
                    stack: 'stack2'
                },
                {
                    label: 'Соединений к хосту',
                    data: [null, hostConnections, null, null],
                    backgroundColor: '#9AD0F5',
                    yAxisID: 'y',
                    stack: 'stack2'
                },

                // === Ошибки ===
                {
                    label: 'SYN ошибки',
                    data: [null, null, serror, null],
                    backgroundColor: '#FA7233',
                    yAxisID: 'y',
                    stack: 'stack3'
                },
                {
                    label: 'REJ ошибки',
                    data: [null, null, rerror, null],
                    backgroundColor: '#F12E2E',
                    yAxisID: 'y',
                    stack: 'stack3'
                },
                {
                    label: 'DST_TO_SRC ошибки',
                    data: [null, null, dstToSrcRate, null],
                    backgroundColor: '#E64A19',
                    yAxisID: 'y',
                    stack: 'stack3'
                },

                // === Протоколы и сервисы (категориальные данные) ===
                {
                    label: 'Тип протокола',
                    data: [null, null, null, protocolType],
                    backgroundColor: '#AB47BC',
                    yAxisID: 'y1',
                    type: 'line',
                    borderColor: '#AB47BC',
                    borderWidth: 2,
                    fill: false
                },
                {
                    label: 'Тип сервиса',
                    data: [null, null, null, serviceType],
                    backgroundColor: '#42A5F5',
                    yAxisID: 'y1',
                    type: 'line',
                    borderColor: '#42A5F5',
                    borderWidth: 2,
                    fill: false
                },
                {
                    label: 'Сервисы на хосте',
                    data: [null, null, null, sameHostService],
                    backgroundColor: '#66BB6A',
                    yAxisID: 'y1',
                    type: 'line',
                    borderColor: '#66BB6A',
                    borderWidth: 2,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Числовые значения'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Категориальные данные (нормализованные)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Комплексный анализ сетевого трафика'
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
        }
    
            function exportResults() {
                const table = document.querySelector('.result-table');
                const csv = tableToCSV(table);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'analysis_results.csv';
                a.click();
            }
    
            function tableToCSV(table) {
                const rows = [];
                // Добавляем статус как первую строку
                rows.push(`Статус,${document.getElementById('statusBadge').textContent}`);
                rows.push('');
                
                // Получаем заголовки
                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
                rows.push(headers.join(','));
                
                // Получаем данные строк
                table.querySelectorAll('tr').forEach(tr => {
                    const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
                    if (cols.length > 0) rows.push(cols.join(','));
                });
    
                return rows.join('\n');
            }
    
            // Дропзона анимация
            const dropzone = document.getElementById('dropzone');
            dropzone.ondragover = (e) => {
                e.preventDefault();
                dropzone.style.borderColor = '#64ffda';
            };
            dropzone.ondragleave = () => {
                dropzone.style.borderColor = getComputedStyle(dropzone).borderColor;
            };
            
        </script>
</body>
</html>